#!/bin/bash -e

ROOT=$(realpath $(dirname $0)/..)
cd $ROOT

FSOCK=faucet_event.sock
PYTHONPATH=faucet:$PYTHONPATH

if [ -n "$1" ]; then
    FORCH_BASE=$1
    shift
    FAUCET_EVENT_SOCK=$FORCH_BASE/$FSOCK
    FORCH_CONFIG_DIR=$FORCH_BASE
    FORCH_LOG_DIR=$FORCH_BASE
else
    FAUCET_EVENT_SOCK=${FAUCET_EVENT_SOCK:-/var/run/faucet/$FSOCK}
    FORCH_CONFIG_DIR=${FORCH_CONFIG_DIR:-/etc/faucet}
    FORCH_LOG_DIR=${FORCH_LOG_DIR:-/var/log/faucet}
    mkdir -p $FORCH_LOG_DIR $FORCH_CONFIG_DIR
fi

if [ -f venv/bin/python ]; then
    PYTHON=venv/bin/python3
else
    PYTHON=python3
fi

if [ -z "$CONTROLLER_NAME" ]; then
    CONTROLLER_NAME=$(hostname -s)
    echo Setting controller name to $CONTROLLER_NAME
else
    echo Using existing controller name $CONTROLLER_NAME
fi

echo Writing forch logs to $FORCH_LOG_DIR/forch.log

sudo \
    CONTROLLER_NAME=$CONTROLLER_NAME \
    FAUCET_EVENT_SOCK=$FAUCET_EVENT_SOCK \
    FORCH_CONFIG_DIR=$FORCH_CONFIG_DIR \
    FORCH_LOG_DIR=$FORCH_LOG_DIR \
    PYTHONPATH=$PYTHONPATH \
    $PYTHON -m forch.forchestrator
