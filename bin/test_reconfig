#!/bin/bash

source bin/stack_functions

export CONTROLLER_NAME=127.0.0.1

TEST_RESULTS=${TEST_RESULTS:-$out_dir/test_reconfig.out}
GOLDEN_RESULTS=etc/test_reconfig.out
TCPSUDO="sudo tcpdump"
controllers=`sudo ovs-vsctl get-controller t1sw1`

local=
if [ "$1" == local ]; then
    local=y
    shift
fi

cap_base=10
ping_count=10
num_pairs=12
cap_length=$((cap_base + ping_count + num_pairs * 2))

faucet_log=inst/forch-faucet-1/faucet.log
forch_log=inst/forch-faucet-1/forch.log

#################################################################################

rm -f $faucet_log inst/forch-faucet-1/ofchannel.log

rest_system

reset_stack

# Force t1sw1 to be the active link
echo t1sw2-eth28 down
sudo ip link set t1sw2-eth28 down

restart_ovs init

restart_forch

sleep 10
echo t1sw2-eth28 up
sudo ip link set t1sw2-eth28 up
sleep 10


test_stack -solid

sleep 10
echo t1sw1-eth28 down
sudo ip link set t1sw1-eth28 down
sleep 10

echo %%% t1sw1 egress down | tee -a $TEST_RESULTS
test_stack -broken

finalize_test
