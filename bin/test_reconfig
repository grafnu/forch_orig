#!/bin/bash

source bin/stack_functions

preamble_setup

faucet_log=inst/forch-faucet-1/faucet.log
forch_log=inst/forch-faucet-1/forch.log

#################################################################################

function simple_ping {
    label=$1
    rm -f $OUT_DIR/t1sw1-eth28.pcap $OUT_DIR/t1sw2-eth28.pcap
    sudo timeout 3s tcpdump -lw $OUT_DIR/t1sw1-eth28.pcap -i t1sw1-eth28 &
    sudo timeout 3s tcpdump -lw $OUT_DIR/t1sw2-eth28.pcap -i t1sw2-eth28 &
    sleep 0.5
    ping=`docker exec forch-faux-1 ping -q -c 2 192.168.1.0 | fgrep packets`
    sleep 2.5
    sw1=`tcpdump -r $OUT_DIR/t1sw1-eth28.pcap | wc -l`
    sw2=`tcpdump -r $OUT_DIR/t1sw2-eth28.pcap | wc -l`
    pingc=`echo $ping | sed -e 's/, time.*//'`
    echo ping $label $((sw1 > 5)) $((sw1 < 11)) $((sw2 > 5)) $((sw2 < 11)) $pingc | tee -a $TEST_RESULTS
    tcpdump -r $OUT_DIR/t1sw2-eth28.pcap
}

rm -f $faucet_log inst/forch-faucet-1/ofchannel.log

reset_system

reset_stack

# Force t1sw1 to be the active link
sudo ip link set t1sw2-eth28 down

restart_ovs init

sleep 10

simple_ping sw2down

sudo ip link set t1sw2-eth28 up
sleep 30

simple_ping sw2up

sleep 10
sudo ip link set t1sw1-eth28 down

for trial in 1 2 3 4 5 6 7 8 9; do
    simple_ping trial$trial
done

echo Done with test_reconfig. | tee -a $TEST_RESULTS
